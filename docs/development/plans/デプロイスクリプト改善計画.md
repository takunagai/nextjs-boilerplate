# デプロイスクリプト改善計画

## 概要

Cloudflare Workers へのデプロイ時に発生した問題を修正し、デプロイプロセスを改善する。

## 発生した問題

### 問題 1: 2重ビルドによるデプロイ失敗（重大）

**現状の `build:cloudflare` スクリプト:**
```json
"build:cloudflare": "npm run build && opennextjs-cloudflare build"
```

**問題点:**
1. `npm run build` で `next build` が実行される（1回目）
2. `opennextjs-cloudflare build` が内部で再度 `npm run build` を実行する（2回目）
3. 2回目のビルドが1回目の `.next` キャッシュと干渉し、`[turbopack]_runtime.js` を参照してエラーになる

**エラーメッセージ:**
```
Cannot find module '../chunks/ssr/[turbopack]_runtime.js'
```

**原因:** dev サーバー（`next dev --turbopack`）が使用する Turbopack のキャッシュが `.next` ディレクトリ内に残り、2回目のインクリメンタルビルドで参照されてしまう。

### 問題 2: 不要ファイルが本番環境にデプロイされている（軽度）

デプロイログで以下の不要ファイルがアップロードされていた:

| ファイル | 場所 | 原因 |
|----------|------|------|
| `.DS_Store` (4件) | `public/`, `public/images/`, `public/dummy-images/`, `public/dummy-images/tech/` | macOS が自動生成 |
| `CLAUDE.md` | `public/images/CLAUDE.md` | claude-mem が自動生成 |

`.gitignore` には `.DS_Store` と `**/CLAUDE.md` が含まれているが、ローカルファイルシステムには存在するため、OpenNext のアセットコピー時に含まれてしまう。

---

## 修正内容

### 修正 1: `build:cloudflare` スクリプトの修正

**変更前:**
```json
"build:cloudflare": "npm run build && opennextjs-cloudflare build"
```

**変更後:**
```json
"build:cloudflare": "opennextjs-cloudflare build"
```

**理由:**
- `opennextjs-cloudflare build` は内部で `npm run build`（= `next build`）を自動実行する
- 明示的な `npm run build` を削除することで2重ビルドを排除
- ビルド時間が約 13〜17 秒短縮される
- Turbopack キャッシュ干渉の問題が根本解消される

**影響範囲:**
- `build:cloudflare` を使用するスクリプト: `preview:cloudflare`, `deploy:preview`, `deploy:production`
- すべて `build:cloudflare` を呼び出しているため、1箇所の修正で全て改善される

### 修正 2: 不要ファイルの削除

以下のファイルを `public/` ディレクトリから削除:

```bash
# .DS_Store ファイル（4件）
rm public/.DS_Store
rm public/images/.DS_Store
rm public/dummy-images/.DS_Store
rm public/dummy-images/tech/.DS_Store

# claude-mem が生成した CLAUDE.md
rm public/images/CLAUDE.md
```

### 修正 3: wrangler.toml にアセット除外ルールを追加（予防策）

Wrangler の `[assets]` セクションに除外パターンを追加して、今後の不要ファイル混入を防止:

```toml
[assets]
directory = ".open-next/assets"
binding = "ASSETS"

# 不要ファイルの除外
[assets.exclude]
patterns = [".DS_Store", "*.md", "Thumbs.db"]
```

> **注意:** Wrangler のバージョン (`4.39.0`) で `[assets.exclude]` がサポートされているか要確認。未サポートの場合は修正 2 の手動削除 + `.gitignore` の運用で対応する。

---

## 変更対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `package.json` (20行目) | `build:cloudflare` スクリプト修正 |
| `wrangler.toml` (28-29行目) | アセット除外ルール追加（対応確認後） |
| `public/.DS_Store` | 削除 |
| `public/images/.DS_Store` | 削除 |
| `public/dummy-images/.DS_Store` | 削除 |
| `public/dummy-images/tech/.DS_Store` | 削除 |
| `public/images/CLAUDE.md` | 削除 |

## 実装手順

### Step 1: 不要ファイル削除
```bash
find public -name ".DS_Store" -delete
rm -f public/images/CLAUDE.md
```

### Step 2: package.json 修正
```diff
- "build:cloudflare": "npm run build && opennextjs-cloudflare build",
+ "build:cloudflare": "opennextjs-cloudflare build",
```

### Step 3: wrangler.toml 修正（オプション）
アセット除外ルールを追加（Wrangler バージョン互換性確認後）

### Step 4: 動作確認
```bash
# クリーンビルド & ローカルプレビュー
rm -rf .open-next .next
npm run preview:cloudflare

# 問題なければ本番デプロイ
npm run deploy:production

# レスポンス確認
curl -I https://nagai-shouten.com
```

### Step 5: コミット
```
fix(deploy): 2重ビルドの解消と不要アセットの除去
```

---

## リスク評価

| リスク | 影響度 | 対策 |
|--------|--------|------|
| `opennextjs-cloudflare build` 単体で `next build` が正常実行されない | 低（今回のデプロイで内部ビルドの成功を確認済み） | 失敗時は元のスクリプトに戻す |
| `[assets.exclude]` が未サポート | 低（修正 2 の手動削除で対応可能） | 手動削除 + `.gitignore` 運用で継続 |
| dev サーバーの Turbopack キャッシュが再発 | 中（dev → build 切替時） | `rm -rf .next` をデプロイ前の手順に含める |

## 備考

- 現在の Wrangler バージョン: `4.39.0`（最新 `4.63.0` へのアップデートも検討）
- OpenNext バージョン: `@opennextjs/cloudflare@1.8.5`
- デプロイ成功時の Worker 起動時間: 24ms
